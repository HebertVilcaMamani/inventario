/// <reference path="../lib.d.ts" />
var _ = require('underscore');
var formidable = require('formidable');
exports.parse = function (option) {
    if (option === void 0) { option = {}; }
    return function (req, res, next) {
        var contentType = req.headers['content-type'];
        if (contentType && contentType.indexOf('multipart/form-data') >= 0) {
            var form = new formidable.IncomingForm();
            Object.keys(option).forEach(function (optKey) {
                form[optKey] = option[optKey];
            });
            var fields = {};
            function setOrAppend(name, value) {
                if (_.isUndefined(fields[name])) {
                    fields[name] = value;
                    return;
                }
                if (!_.isArray(fields[name])) {
                    fields[name] = [fields[name]];
                }
                fields[name].push(value);
            }
            form
                .on('field', setOrAppend)
                .on('file', setOrAppend)
                .on('error', next)
                .on('end', function () {
                req.body = fields;
                next();
            });
            form.parse(req);
        }
        else {
            next();
        }
    };
};
